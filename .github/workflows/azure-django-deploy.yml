name: Deploy Django to Azure (Simple)

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Django/**'
      - '.github/workflows/azure-django-deploy-simple.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: cpsu-health-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Create deployment package
      run: |
        cd Django
        # Create a clean zip without unnecessary files
        zip -r django-deploy.zip . \
          -x "*.pyc" \
          -x "*__pycache__*" \
          -x "*.sqlite3" \
          -x ".git/*" \
          -x "venv/*" \
          -x "*.log" \
          -x ".env*"
        mv django-deploy.zip ../
        cd ..
        echo "ðŸ“¦ Package size:"
        ls -lh django-deploy.zip
        
    - name: ðŸš€ Deploy via Kudu ZipDeploy API
      run: |
        # Extract credentials from publish profile
        PUBLISH_PROFILE='${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}'
        
        # Extract username and password
        USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP '(?<=userName=")[^"]+' | head -1)
        PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP '(?<=userPWD=")[^"]+' | head -1)
        
        echo "ðŸš€ Deploying to Azure App Service..."
        
        # Deploy using Kudu ZipDeploy API
        HTTP_CODE=$(curl -X POST \
          -u "$USERNAME:$PASSWORD" \
          --data-binary @django-deploy.zip \
          -H "Content-Type: application/zip" \
          -w "%{http_code}" \
          -o deploy-response.txt \
          "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/zipdeploy?isAsync=true")
        
        echo "HTTP Response Code: $HTTP_CODE"
        
        if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 202 ]; then
          echo "âœ… Deployment initiated successfully!"
        else
          echo "âŒ Deployment failed with code $HTTP_CODE"
          cat deploy-response.txt
          exit 1
        fi
        
    - name: â³ Wait for deployment to complete
      run: |
        echo "â³ Waiting for deployment to complete..."
        sleep 60
        
    - name: ðŸ”„ Restart Web App
      run: |
        PUBLISH_PROFILE='${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}'
        USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP '(?<=userName=")[^"]+' | head -1)
        PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP '(?<=userPWD=")[^"]+' | head -1)
        
        echo "ðŸ”„ Restarting web app..."
        curl -X POST \
          -u "$USERNAME:$PASSWORD" \
          "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/app/restart"
        
        echo "âœ… App restart triggered"
        
    - name: â³ Wait for app to start
      run: |
        echo "â³ Waiting for app to start..."
        sleep 30
        
    - name: âœ… Test deployment
      run: |
        echo "ðŸ§ª Testing deployment..."
        
        # Try to reach the app (allow up to 404, just check it's responding)
        for i in {1..5}; do
          echo "Attempt $i/5..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/ || echo "000")
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "000" ] && [ "$HTTP_CODE" != "503" ]; then
            echo "âœ… App is responding!"
            break
          fi
          
          if [ $i -lt 5 ]; then
            echo "Waiting 15 seconds before retry..."
            sleep 15
          fi
        done
        
    - name: âœ¨ Deployment complete
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸŒ URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo ""
        echo "ðŸ“ Next steps:"
        echo "  1. Check logs: az webapp log tail --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group cpsu-health-assistant-rg"
        echo "  2. SSH access: az webapp ssh --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group cpsu-health-assistant-rg"
        echo "  3. Test API: curl https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/"
