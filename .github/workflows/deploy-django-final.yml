name: Deploy Django to Azure

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Django/**'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: cpsu-health-backend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        cd Django
        zip -r ../django-app.zip . \
          -x "*.pyc" \
          -x "*__pycache__/*" \
          -x "*.sqlite3" \
          -x ".git/*" \
          -x "venv/*" \
          -x "env/*" \
          -x "*.log"
        cd ..
        echo "Package size:"
        ls -lh django-app.zip

    - name: Extract credentials
      id: creds
      run: |
        PUBLISH_PROFILE='${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}'
        USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\$[^"]+' | head -1 | cut -d'"' -f2)
        PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="[^"]+' | head -1 | cut -d'"' -f2)

        if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
          echo "Failed to extract credentials"
          exit 1
        fi

        echo "username=$USERNAME" >> $GITHUB_OUTPUT
        echo "::add-mask::$PASSWORD"
        echo "password=$PASSWORD" >> $GITHUB_OUTPUT
        echo "Credentials extracted (user length: ${#USERNAME}, pass length: ${#PASSWORD})"

    - name: Deploy via ZipDeploy
      run: |
        USERNAME='${{ steps.creds.outputs.username }}'
        PASSWORD='${{ steps.creds.outputs.password }}'

        HTTP_CODE=$(curl -X POST \
          -u "${USERNAME}:${PASSWORD}" \
          "https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/zipdeploy?isAsync=true" \
          -H "Content-Type: application/zip" \
          --data-binary @django-app.zip \
          -w "%{http_code}" \
          -o /dev/null \
          -s)

        echo "Deploy response: $HTTP_CODE"

        if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "202" ]; then
          echo "Deployment failed with HTTP $HTTP_CODE"
          exit 1
        fi

        echo "Deployment initiated, waiting for Oryx build..."

    - name: Wait for Oryx build to complete
      run: |
        USERNAME='${{ steps.creds.outputs.username }}'
        PASSWORD='${{ steps.creds.outputs.password }}'
        KUDU="https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net"

        echo "Polling build status (build takes ~5-7 minutes for ML dependencies)..."

        for i in $(seq 1 40); do
          sleep 15

          RESULT=$(curl -s -u "${USERNAME}:${PASSWORD}" "$KUDU/api/deployments/latest" 2>/dev/null || echo '{}')
          STATUS=$(echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('status',''))" 2>/dev/null || echo "")
          COMPLETE=$(echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('complete',''))" 2>/dev/null || echo "")
          PROGRESS=$(echo "$RESULT" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('progress',''))" 2>/dev/null || echo "")

          echo "  [$((i*15))s] Status=$STATUS Complete=$COMPLETE Progress=$PROGRESS"

          if [ "$COMPLETE" = "True" ]; then
            if [ "$STATUS" = "4" ]; then
              echo "Build completed successfully!"
              break
            else
              echo "Build completed with status $STATUS (not success)"
              exit 1
            fi
          fi

          if [ $i -eq 40 ]; then
            echo "Build timed out after 10 minutes"
            exit 1
          fi
        done

    - name: Wait for app to start
      run: |
        echo "Waiting 90 seconds for app to start after build..."
        sleep 90

    - name: Verify deployment
      run: |
        echo "Testing deployment..."

        for i in {1..12}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -m 15 \
            "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/" || echo "000")

          echo "  Attempt $i/12 - HTTP $HTTP_CODE"

          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ] || [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "App is responding! Deployment successful!"
            echo "URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
            exit 0
          fi

          sleep 10
        done

        echo "App not responding yet - check Azure logs"
