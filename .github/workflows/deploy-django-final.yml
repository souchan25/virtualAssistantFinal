name: Deploy Django to Azure (Working)

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Django/**'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: cpsu-health-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîÑ Checkout code
      uses: actions/checkout@v4
      
    - name: üì¶ Create deployment package
      run: |
        cd Django
        echo "Creating deployment package..."
        
        # Create a clean deployment zip
        zip -r ../django-app.zip . \
          -x "*.pyc" \
          -x "*__pycache__/*" \
          -x "*.sqlite3" \
          -x ".git/*" \
          -x "venv/*" \
          -x "env/*" \
          -x "*.log" \
          -x "test_*" \
          -x "*_test.py" \
          -x "tests/*"
        
        cd ..
        echo "üì¶ Package created:"
        ls -lh django-app.zip
        
    - name: üöÄ Deploy using Kudu ZipDeploy
      run: |
        echo "Extracting credentials from publish profile..."
        
        # Get credentials from the publish profile
        PUBLISH_PROFILE='${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}'
        
        # Extract the Zip Deploy profile section
        ZIP_PROFILE=$(echo "$PUBLISH_PROFILE" | grep -oP '<publishProfile[^>]*publishMethod="ZipDeploy"[^>]*>.*?</publishProfile>' | head -1)
        
        if [ -z "$ZIP_PROFILE" ]; then
          echo "‚ö†Ô∏è Zip Deploy profile not found, trying to extract from any profile..."
          USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\$[^"]+' | head -1 | cut -d'"' -f2)
          PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="[^"]+' | head -1 | cut -d'"' -f2)
        else
          USERNAME=$(echo "$ZIP_PROFILE" | grep -oP 'userName="[^"]+' | cut -d'"' -f2)
          PASSWORD=$(echo "$ZIP_PROFILE" | grep -oP 'userPWD="[^"]+' | cut -d'"' -f2)
        fi
        
        echo "Username length: ${#USERNAME}"
        echo "Password length: ${#PASSWORD}"
        
        if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
          echo "‚ùå Failed to extract credentials from publish profile"
          echo "Please update the AZURE_WEBAPP_PUBLISH_PROFILE secret with fresh credentials"
          exit 1
        fi
        
        echo "üöÄ Deploying to Azure App Service..."
        
        # Deploy using Kudu ZipDeploy API with async
        HTTP_CODE=$(curl -X POST \
          "https://$USERNAME:$PASSWORD@${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/zipdeploy?isAsync=true" \
          -H "Content-Type: application/zip" \
          --data-binary @django-app.zip \
          -w "%{http_code}" \
          -o deploy-response.txt \
          -s)
        
        echo "HTTP Response Code: $HTTP_CODE"
        
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
          echo "‚úÖ Deployment initiated successfully!"
          cat deploy-response.txt
        else
          echo "‚ùå Deployment failed with HTTP $HTTP_CODE"
          cat deploy-response.txt
          exit 1
        fi
        
    - name: ‚è≥ Wait for deployment
      run: |
        echo "‚è≥ Waiting 90 seconds for deployment to complete..."
        sleep 90
        
    - name: üîÑ Restart web app
      run: |
        PUBLISH_PROFILE='${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}'
        USERNAME=$(echo "$PUBLISH_PROFILE" | grep -oP 'userName="\$[^"]+' | head -1 | cut -d'"' -f2)
        PASSWORD=$(echo "$PUBLISH_PROFILE" | grep -oP 'userPWD="[^"]+' | head -1 | cut -d'"' -f2)
        
        echo "üîÑ Restarting app..."
        curl -X POST \
          "https://$USERNAME:$PASSWORD@${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/api/app/restart" \
          -s
        
        echo "‚úÖ Restart triggered"
        
    - name: ‚è≥ Wait for app to start
      run: |
        echo "‚è≥ Waiting 45 seconds for app to start..."
        sleep 45
        
    - name: ‚úÖ Verify deployment
      run: |
        echo "üß™ Testing deployment..."
        
        for i in {1..10}; do
          echo "Attempt $i/10..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -m 10 \
            "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/" || echo "000")
          
          echo "  HTTP Code: $HTTP_CODE"
          
          # Accept any non-5xx response as success
          if [ "$HTTP_CODE" != "000" ] && [ "$HTTP_CODE" != "503" ] && [ "$HTTP_CODE" != "502" ]; then
            echo "‚úÖ App is responding!"
            echo ""
            echo "üéâ Deployment successful!"
            echo "üåê URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
            exit 0
          fi
          
          if [ $i -lt 10 ]; then
            echo "  Waiting 10 seconds before retry..."
            sleep 10
          fi
        done
        
        echo "‚ö†Ô∏è App is not responding yet, but deployment may still be processing"
        echo "Check logs: az webapp log tail --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group cpsu-health-assistant-rg"
